<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="NANA NANA">
    <meta name="theme-color" content="#08081a">
    <link rel="icon" type="image/png" href="icon1.png">

<link rel="apple-touch-icon" href="icon1.png">

<link rel="manifest" href="manifest.json">
    <title>NANA NANA BOO BOO // RHYTHM ARCADE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        :root {
            --primary: #5dade2; --teacher: #ff9f43; --student: #10ac84;
            --bg: #08081a; --bg-glow: #0a0a25; --card-bg: #1a1a2e; --text: #ffffff; --arcade-red: #e94560;
            --banana-gold: #FFD700;
            --easy: #5dade2; --medium: #f1c40f; --hard: #e67e22; --expert: #e94560;
        }
        * { user-select: none; -webkit-user-select: none; outline: none; box-sizing: border-box; touch-action: manipulation; }
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: var(--bg); color: var(--text);
            margin: 0; overflow-x: hidden; min-height: 100vh;
            display: flex; justify-content: center; align-items: center;
            background: radial-gradient(circle at center, var(--bg-glow) 0%, var(--bg) 100%);
        }
        #start-screen { position: fixed; width: 100%; height: 100%; top:0; left:0; background: inherit; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 50; transition: transform 0.6s cubic-bezier(0.87, 0, 0.13, 1); padding: 20px; }
        #start-screen.hidden { transform: translateY(-100%); }
        .title-group { text-align: center; margin-bottom: 40px; }
        .main-title { font-size: 3rem; color: #fff; text-shadow: 0 0 20px var(--arcade-red), 8px 8px 0px #000; margin: 0; }
        .press-start { font-family: 'Press Start 2P'; font-size: 1.8rem; padding: 30px 60px; background: #10ac84; color: #fff; border: 6px solid #fff; cursor: pointer; box-shadow: 0 12px 0 #064d3b; transition: all 0.1s; }
        .press-start:active { transform: translateY(4px); box-shadow: 0 8px 0 #064d3b; }
        #game-container { width: 95%; max-width: 1100px; display: none; flex-direction: column; align-items: center; padding: 20px 0 100px 0; }
        #game-container.visible { display: flex; }
        #measure { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 100%; }
        .beat-cell { background: #0a0a1a; border: 4px solid #1a1a30; height: 130px; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.1s; }
        .teacher-active .beat-cell.active { border-color: var(--teacher); box-shadow: 0 0 20px var(--teacher); transform: scale(1.02); }
        .student-active .beat-cell.active { border-color: var(--student); box-shadow: 0 0 20px var(--student); transform: scale(1.02); }
        .picker-container { display: flex; gap: 8px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center; width: 100%; }
        .rhythm-card { background: var(--card-bg); border: 3px solid #333; padding: 8px; width: 80px; height: 105px; display: flex; flex-direction: column; align-items: center; justify-content: space-between; cursor: pointer; transition: all 0.2s; }
        .rhythm-card.selected { border-color: var(--primary); background: #252545; box-shadow: 0 0 15px var(--primary); }
        #adv-toggle { color: var(--primary); font-size: 10px; margin-bottom: 20px; cursor: pointer; }
        .controls { margin-top: 30px; width: 100%; background: #111125; padding: 20px; border-radius: 15px; text-align: center; border: 4px solid #333; }
        #toggle-btn { font-family: 'Press Start 2P'; width: 100%; padding: 18px; background: var(--arcade-red); color: #fff; border: none; box-shadow: 0 6px #9a2b3e; cursor: pointer; font-size: 1.2rem; margin-top: 15px; }
        #toggle-btn:active { transform: translateY(3px); box-shadow: 0 3px #9a2b3e; }
        .patch-btn { font-family: 'Press Start 2P'; font-size: 8px; padding: 8px; background: #111125; color: #888; border: 2px solid #444; border-radius: 4px; transition: all 0.2s; }
        .patch-btn.active { background: var(--primary); color: #fff; border-color: #fff; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 8px; background: #333; border-radius: 4px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%; background: var(--primary); cursor: pointer; margin-top: -8px; border: 3px solid #fff; }
        
        @media (max-width: 600px) { .main-title { font-size: 1.4rem !important; } .beat-cell { height: 100px; } }
    </style>
</head>
<body>
    <div id="start-screen">
        <div class="title-group">
            <h1 class="main-title">NANA NANA BOO BOO</h1>
        </div>
        <pre style="font-size: 10px; color: var(--banana-gold); line-height: 1.2;">
                                                                                                                                  
                                                                                                                              
                                                                                                                              
                                                                                                                              
                                                                                                                              
                                  .+    =*                               +-.  :==*                                            
                                  :.-  = =                            #=.  . .  .  =#                                         
                                 .:.=  :.= .-:*                     *-.  ..  . . .   :*     +=                                
                                  :.+  : * *.::             @     *:.  .  . . .  .. . .+   *.-.*=                             
                                 .:.+ @..=#: :*            @@@@@%: . . ..  .  . .  .  ..=.%= =%::                             
                        :=:+      :.+.= :%- .*             @@@@@@@@#-.  .. . . .  . .. ::.*:.=+.:                             
                          *::-   .: +=: :-:.:              @@@@@@@@@@@@*. . .  . .  . .* :-:.*-.-   @::*                      
                            -.:* *. ::. == .=              @+@@@@@@@@@#=--%+. . . ..  -:.-+.:%=.=  *:.+                       
                             =. .  ..  . .  +             *: .-#@@@#=. . -@@@@@*.  . :@  :: = - = -: =                        
                             @: . .  . . ..:@            @: .  .  .  .  .-@@@@@@@@@*:%= . . .:. =::.=                         
                             .=  . . .  .  *             : . .  .  .  . ..@@@@@@@@@@@@= .  .  .... :                          
                             =.. . .  . . .@   +=*@    #.  . .. .. .. .  . *@@@@@@@@@.-  . ..   . .#                          
                          *%**. . . . .  .  .:====::::=. :.   .  .  .  .  .  .:=#    #.. .  .. .  =                           
                       *##******- . .  . . .  . . :::::-:-. .  . .+=:.. . . . .%   *:.  . .  . . .=                           
                    ##%***********.  . . ..:=--===-::::::==. . . :::::::+. ..=. . . .  .  ..  . ..:                           
                 *#%**************-=+%+==::::::::::::::::::=. . . =::::-:  . *==-::::.. ..  . . .:+@                          
              *##**************#%  :--:::::::::::::::::::::::+...  .  .  .. :::::::::-*@*:..:=******%                         
           *###**************%    ::-:::::::::::::::::::::::::-:::. .  .  .:::::::::::::=:*#**********%#                      
         *##**************#@      :=::::::::::::::::--=====--::::.  :--:.::=-::::::::::::--  %**********###                   
      *##***************#@       :-::::::::::::::==-----------::=:-------:::::::=-==++==-:=:  @%***********#%                 
    %##****************%         :-:::::::::::+**=-----------===:-:::::::::::-----=:            %%***********#%               
   %******************%#        :=:::::::::=#*+=++-------------+:-=:::::::::::::::-+::            %#***********#%*            
  %*****************#****######%%::::::::=@  ++==*=------------*:::=::::::::::::::::=-:            %%*************#*          
 %**************###**************::::::*******+==*=------------+*::::-=-::::::::::::::=::            @%*************%*        
   %####*****#*******************=:::*********+=+**------------===::::::::+#*::::::::::+=#%%@          %**************%*      
        ***#######%#%%#**********#-*************#**------------===::::::::#*****::::::::=******#%%*     %#*************#*     
                  *********##*#%%#*****************-------------++::::::::=#*****+:::::::#**********#%@  @**************##    
                                 ****#%#***********+------------++:::::::::*******#::::::=****************#***************%   
                                          #%#******#-------------*:::::::::+*******#-::::-*****************#***************%  
                                               @%#**+------------+*::::::::**********=:::+********************%%***********## 
                                                    @=-----------=@::::::::#+#********=:=**********************************%* 
                                                      =-----------*%::::::::%+*********=*********************************%#*  
                                                       +-----------**::::::::@==#************************************#%**     
                                                        *----------=#+-::::::-@==: *****#%%%########*******####%%%#           
                                                         *=---------=+==::::::+*:+               ************                 
                                                           *=---------===:::::=--=                                            
                                                             *=---------++-::::+-=                                            
                                                               +=--------=+*::::==                                            
                                                                 **=-------=**::::===:                                        
                                                                    %*+======@@+=:::::::+                                     
                                                                                  #=-:::*                                     
                                                                                     =*                                       
                                                                                                                              
                                                                                                                              
                                                                                                                              
                                                                                                                              

</pre>
        <button class="press-start" id="boot-btn">START GAME</button>
    </div>

    <div id="game-container">
        <div class="picker-container" id="picker-basic"></div>
        <div id="adv-toggle">[+] SHOW ADVANCED</div>
        
        <div id="time-sig-panel" style="display:none; text-align: center; margin-bottom: 15px;">
            <div style="font-size: 8px; color: var(--primary); margin-bottom: 10px;">TIME SIGNATURE:</div>
            <select id="time-sig-select" style="background: #111125; color: #fff; border: 2px solid #444; font-family: 'Press Start 2P'; font-size: 10px; padding: 8px;">
                <option value="1">1/4</option><option value="2">2/4</option><option value="3">3/4</option>
                <option value="4" selected>4/4</option><option value="5">5/4</option><option value="6">6/4</option>
                <option value="7">7/4</option><option value="8">8/4</option>
            </select>
        </div>

        <div class="picker-container" id="picker-adv" style="display:none; border-top: 2px dashed #444; padding-top: 20px; margin-bottom: 20px;"></div>
        <div id="status-banner" style="font-size:1rem; margin-bottom:15px; text-shadow: 2px 2px #000;">PICK BEATS</div>
        <div id="measure"></div>

        <div class="controls">
            <div style="font-size: 8px; letter-spacing: 1px;">SPEED: <span id="tempo-val">80 BPM</span></div>
            <span id="rank-label" style="font-size: 10px; margin-top: 10px; display: block; color: var(--easy);">[EASY]</span>
            <input type="range" id="tempo-slider" min="40" max="200" value="80" style="width:100%; margin: 15px 0;">
            <div style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
                <button class="patch-btn active" data-patch="classic">SYNTH</button>
                <button class="patch-btn" data-patch="bloop">BLOOP</button>
            </div>
            <button id="toggle-btn">START</button>
        </div>
    </div>

<script>
    let audioCtx, masterGain, isRunning = false, tempo = 80, beatsPerMeasure = 4, currentBeatIndex = 0, isTeacherTurn = true, currentRhythm = [], soundType = 'classic', nextNoteTime = 0;
    const toggleBtn = document.getElementById('toggle-btn'), timeSigSelect = document.getElementById('time-sig-select');

    const RHYTHM_CONFIG = { 
        Boo: { offsets: [0], name: "BOO" }, 
        Nana: { offsets: [0, 0.5], name: "NANA" }, 
        Gullible: { offsets: [0, 0.333, 0.666], name: "GULLIBLE" }, 
        LiarLiar: { offsets: [0, 0.25, 0.5, 0.75], name: "LIAR LIAR" }, 
        Rest: { offsets: [], name: "REST" },
        Offbeat: { offsets: [0.5], name: "" },
        Adv1: { offsets: [0, 0.5, 0.75], name: "" }
    };

    const SVGS = { 
        Boo: `<svg viewBox="0 0 60 100" width="30"><ellipse cx="20" cy="80" rx="12" ry="8" fill="white" transform="rotate(-15, 20, 80)"/><rect x="29" y="20" width="4" height="62" fill="white"/></svg>`, 
        Nana: `<svg viewBox="0 0 80 100" width="40"><ellipse cx="15" cy="80" rx="10" ry="7" fill="white" transform="rotate(-15, 15, 80)"/><rect x="22" y="20" width="4" height="62" fill="white"/><ellipse cx="55" cy="80" rx="10" ry="7" fill="white" transform="rotate(-15, 55, 80)"/><rect x="62" y="20" width="4" height="62" fill="white"/><rect x="22" y="20" width="44" height="10" fill="white"/></svg>`, 
        Gullible: `<svg viewBox="0 0 100 100" width="45"><text x="50" y="16" fill="white" font-size="12" text-anchor="middle">3</text><ellipse cx="12" cy="80" rx="8" ry="6" fill="white"/><rect x="17" y="24" width="3" height="58" fill="white"/><ellipse cx="45" cy="80" rx="8" ry="6" fill="white"/><rect x="50" y="24" width="3" height="58" fill="white"/><ellipse cx="78" cy="80" rx="8" ry="6" fill="white"/><rect x="83" y="24" width="3" height="58" fill="white"/><rect x="17" y="24" width="69" height="8" fill="white"/></svg>`, 
        LiarLiar: `<svg viewBox="0 0 100 100" width="45"><ellipse cx="10" cy="80" rx="7" ry="5" fill="white"/><rect x="15" y="20" width="3" height="62" fill="white"/><ellipse cx="35" cy="80" rx="7" ry="5" fill="white"/><rect x="40" y="20" width="3" height="62" fill="white"/><ellipse cx="60" cy="80" rx="7" ry="5" fill="white"/><rect x="65" y="20" width="3" height="62" fill="white"/><ellipse cx="85" cy="80" rx="7" ry="5" fill="white"/><rect x="90" y="20" width="3" height="62" fill="white"/><rect x="15" y="20" width="78" height="7" fill="white"/><rect x="15" y="32" width="78" height="7" fill="white"/></svg>`, 
        Rest: `<svg viewBox="0 0 60 100" width="20"><path d="M15 20 L45 20 L25 45 L45 55 L25 80" stroke="#444" stroke-width="10" fill="none" stroke-linecap="round"/></svg>`,
        Offbeat: `<svg viewBox="0 0 80 100" width="30"><circle cx="20" cy="35" r="4" fill="white"/><ellipse cx="50" cy="80" rx="10" ry="7" fill="white"/><rect x="58" y="20" width="4" height="62" fill="white"/></svg>`,
        Adv1: `<svg viewBox="0 0 100 100" width="40"><ellipse cx="15" cy="80" rx="7" ry="5" fill="white"/><rect x="20" y="20" width="3" height="62" fill="white"/><rect x="20" y="20" width="73" height="7" fill="white"/></svg>`
    };

    function initAudio() { if (!audioCtx) { audioCtx = new (window.AudioContext || window.webkitAudioContext)(); masterGain = audioCtx.createGain(); masterGain.connect(audioCtx.destination); } if (audioCtx.state === 'suspended') audioCtx.resume(); }

    Object.keys(RHYTHM_CONFIG).forEach(key => {
        const card = document.createElement('div');
        card.className = `rhythm-card ${['Boo','Nana'].includes(key)?'selected':''}`;
        card.dataset.type = key;
        card.innerHTML = SVGS[key] + `<div style="font-size:6px;">${RHYTHM_CONFIG[key].name}</div>`;
        card.onclick = () => { card.classList.toggle('selected'); initAudio(); };
        if (RHYTHM_CONFIG[key].name) document.getElementById('picker-basic').appendChild(card);
        else document.getElementById('picker-adv').appendChild(card);
    });

    document.getElementById('adv-toggle').onclick = function() { 
        const p = document.getElementById('picker-adv'), s = document.getElementById('time-sig-panel');
        const show = p.style.display === 'none';
        p.style.display = show ? 'flex' : 'none'; s.style.display = show ? 'block' : 'none';
        this.innerText = show ? '[-] HIDE ADVANCED' : '[+] SHOW ADVANCED';
    };

    timeSigSelect.onchange = (e) => {
        beatsPerMeasure = parseInt(e.target.value);
        document.getElementById('measure').style.gridTemplateColumns = `repeat(${beatsPerMeasure}, 1fr)`;
        if (currentBeatIndex >= beatsPerMeasure) currentBeatIndex = 0;
        generateNewPattern();
        updateUI(currentBeatIndex, audioCtx ? audioCtx.currentTime : 0, isTeacherTurn);
    };

    function generateNewPattern() {
        const sel = Array.from(document.querySelectorAll('.rhythm-card.selected')).map(c => c.dataset.type);
        if (sel.length === 0) return;
        if (beatsPerMeasure === 4 && sel.includes("Nana") && sel.includes("Boo") && sel.length === 2) {
            currentRhythm = ["Nana", "Nana", "Boo", "Boo"];
        } else {
            currentRhythm = Array.from({length: beatsPerMeasure}, () => sel[Math.floor(Math.random() * sel.length)]);
        }
    }

    function updateUI(idx, time, teacher) {
        const delay = Math.max(0, (time - audioCtx.currentTime) * 1000);
        setTimeout(() => {
            if (!isRunning) return;
            if (idx >= beatsPerMeasure) return; // Fix stacking bug
            const m = document.getElementById('measure');
            if ((idx === 0 && teacher) || m.children.length !== beatsPerMeasure) {
                m.innerHTML = '';
                currentRhythm.forEach(key => {
                    const c = document.createElement('div'); c.className = 'beat-cell';
                    c.innerHTML = SVGS[key]; m.appendChild(c);
                });
            }
            document.getElementById('status-banner').innerText = teacher ? "WATCH!" : "CLAP!";
            document.getElementById('status-banner').style.color = teacher ? "var(--teacher)" : "var(--student)";
            document.getElementById('measure').className = teacher ? "teacher-active" : "student-active";
            const cells = document.querySelectorAll('.beat-cell');
            cells.forEach((c, i) => c.classList.toggle('active', i === idx));
        }, delay);
    }

    function playTone(freq, time, vol=0.2, dur=0.1) {
        const g = audioCtx.createGain(); g.connect(masterGain);
        g.gain.setValueAtTime(vol, time); g.gain.exponentialRampToValueAtTime(0.001, time + dur);
        const osc = audioCtx.createOscillator(); osc.type = soundType==='classic'?'square':'sine';
        osc.frequency.setValueAtTime(freq, time); osc.connect(g); osc.start(time); osc.stop(time + dur);
    }

    function schedule() {
        const secondsPerBeat = 60 / tempo;
        while (isRunning && nextNoteTime < audioCtx.currentTime + 0.1) {
            if (isTeacherTurn) {
                const type = currentRhythm[currentBeatIndex];
                RHYTHM_CONFIG[type].offsets.forEach(o => {
                    playTone(600, nextNoteTime + (o * secondsPerBeat));
                });
            }
            updateUI(currentBeatIndex, nextNoteTime, isTeacherTurn);
            nextNoteTime += secondsPerBeat;
            currentBeatIndex++;
            if (currentBeatIndex >= beatsPerMeasure) { 
                currentBeatIndex = 0; 
                isTeacherTurn = !isTeacherTurn; 
                if (isTeacherTurn) generateNewPattern(); 
            }
        }
        if (isRunning) requestAnimationFrame(schedule);
    }

    document.getElementById('tempo-slider').oninput = (e) => { 
        tempo = e.target.value; 
        document.getElementById('tempo-val').innerText = tempo + " BPM";
        let rk = tempo < 90 ? {t:"[EASY]", c:"--easy"} : tempo < 140 ? {t:"[MED]", c:"--medium"} : tempo < 180 ? {t:"[HARD]", c:"--hard"} : {t:"[EXPERT]", c:"--expert"};
        document.getElementById('rank-label').innerText = rk.t;
        document.getElementById('rank-label').style.color = `var(${rk.c})`;
    };
    
    document.querySelectorAll('.patch-btn').forEach(btn => {
        btn.onclick = () => {
            document.querySelectorAll('.patch-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            soundType = btn.dataset.patch;
        };
    });

    document.getElementById('boot-btn').onclick = () => { initAudio(); generateNewPattern(); document.getElementById('start-screen').classList.add('hidden'); document.getElementById('game-container').classList.add('visible'); };
    
    toggleBtn.onclick = () => { 
        initAudio();
        if (!isRunning) { 
            isRunning = true; 
            currentBeatIndex = 0; 
            isTeacherTurn = true;
            nextNoteTime = audioCtx.currentTime + 0.1; 
            toggleBtn.innerText = "STOP"; 
            schedule(); 
        } else { 
            isRunning = false; 
            toggleBtn.innerText = "START"; 
        } 
    };
</script>
</body>
</html>

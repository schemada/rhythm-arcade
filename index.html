<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NANA NANA BOO BOO // RHYTHM ARCADE</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        :root {
            --primary: #5dade2; --teacher: #ff9f43; --student: #10ac84;
            --bg: #08081a; --bg-glow: #0a0a25; --card-bg: #1a1a2e; --text: #ffffff; --arcade-red: #e94560;
            --banana-gold: #FFD700;
            --easy: #5dade2; --medium: #f1c40f; --hard: #e67e22; --expert: #e94560;
        }

        * { user-select: none; -webkit-user-select: none; outline: none; box-sizing: border-box; touch-action: manipulation; }

        body {
            font-family: 'Press Start 2P', cursive;
            background-color: var(--bg); color: var(--text);
            margin: 0; overflow: hidden; height: 100vh;
            display: flex; justify-content: center; align-items: center;
            background: radial-gradient(circle at center, var(--bg-glow) 0%, var(--bg) 100%);
        }

        body::before {
            content: " "; display: block; position: fixed; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.15) 50%), 
                        linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
            z-index: 1001; background-size: 100% 6px, 4px 100%; pointer-events: none;
            animation: scanline 30s linear infinite;
        }

        body::after {
            content: " "; display: block; position: fixed; top: 0; left: 0; bottom: 0; right: 0;
            background: radial-gradient(circle, transparent 30%, rgba(0,0,0,0.5) 100%);
            z-index: 1002; pointer-events: none;
            animation: flicker 0.4s infinite;
        }

        @keyframes scanline { from { background-position: 0 0; } to { background-position: 0 100%; } }
        @keyframes flicker { 0% { opacity: 0.98; } 50% { opacity: 0.96; } 100% { opacity: 0.98; } }

        #start-screen {
            position: absolute; width: 100%; height: 100%;
            background: inherit;
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 50;
            transition: transform 0.6s cubic-bezier(0.87, 0, 0.13, 1);
        }
        #start-screen.hidden { transform: translateY(-100%); }

        .mascot-box {
            font-family: monospace; font-size: clamp(3px, 0.8vw, 6px); line-height: 1.1;
            color: var(--banana-gold); white-space: pre; text-align: center;
            filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.5));
            margin-bottom: 30px;
            animation: mascotThump 0.5s ease-in-out infinite alternate;
        }
        @keyframes mascotThump { 0% { transform: scale(1.15) translateY(0); } 100% { transform: scale(1.25) translateY(-20px); } }

        .title-group { text-align: center; margin-bottom: 50px; }
        .main-title { 
            font-size: 3rem; color: #fff; 
            text-shadow: 0 0 20px var(--arcade-red), 8px 8px 0px #000; 
            margin: 0;
            animation: neonPulse 1.5s infinite alternate;
        }
        @keyframes neonPulse { 0% { text-shadow: 0 0 15px var(--arcade-red), 0 0 30px var(--arcade-red), 8px 8px 0px #000; filter: brightness(1); } 100% { text-shadow: 0 0 35px var(--arcade-red), 0 0 70px var(--arcade-red), 8px 8px 0px #000; filter: brightness(1.4); } }

        .sub-title { font-size: 1.2rem; color: var(--primary); letter-spacing: 8px; margin-top: 20px; }
        .press-start {
            font-family: 'Press Start 2P'; font-size: 1.8rem; padding: 30px 60px;
            background: #10ac84; color: #fff; border: 6px solid #fff; cursor: pointer;
            box-shadow: 0 12px 0 #064d3b;
            animation: btnThump 0.4s infinite alternate;
        }
        @keyframes btnThump { 0% { transform: scale(1); } 100% { transform: scale(1.1); box-shadow: 0 18px 0 #064d3b; } }

        #game-container { width: 95%; max-width: 1100px; display: none; flex-direction: column; align-items: center; }
        #game-container.visible { display: flex; }

        #central-light { width: 100%; height: 20px; background: white; border-radius: 10px; box-shadow: 0 0 40px white; margin-bottom: 30px; opacity: 0; }
        .light-flash { animation: flashAnim 0.15s ease-out; }
        @keyframes flashAnim { 0% { opacity: 1; transform: scaleX(1); } 100% { opacity: 0; transform: scaleX(1.15); } }

        .picker-container { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; width: 100%; }
        .rhythm-card { 
            background: var(--card-bg); border: 4px solid #333; padding: 15px; width: 130px; height: 160px;
            display: flex; flex-direction: column; align-items: center; justify-content: space-between; cursor: pointer;
            transition: transform 0.1s;
        }
        .rhythm-card:active { transform: scale(0.9); }
        .rhythm-card.selected { border-color: var(--primary); background: #252545; box-shadow: 0 0 25px var(--primary); }

        #adv-toggle { color: var(--primary); font-size: 12px; margin-bottom: 20px; cursor: pointer; text-shadow: 2px 2px #000; transition: color 0.2s; }
        #adv-toggle:hover { color: #fff; }

        .measure-wrapper { position: relative; width: 100%; }
        #lock-btn {
            position: absolute; right: 0; top: -45px; cursor: pointer;
            background: #1a1a30; border: 3px solid #444; padding: 10px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        #lock-btn.locked { border-color: var(--arcade-red); box-shadow: 0 0 15px var(--arcade-red); background: #301010; }
        #lock-btn svg { width: 20px; height: 20px; fill: #888; transition: fill 0.2s; }
        #lock-btn.locked svg { fill: var(--arcade-red); }

        #measure { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; width: 100%; }
        .beat-cell { background: #0a0a1a; border: 6px solid #1a1a30; height: 220px; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .teacher-active .beat-cell.active { border-color: var(--teacher); box-shadow: 0 0 30px var(--teacher); }
        .student-active .beat-cell.active { border-color: var(--student); box-shadow: 0 0 30px var(--student); }

        .controls { margin-top: 40px; width: 100%; background: #111125; padding: 40px; border-radius: 20px; text-align: center; border: 4px solid #333; }
        input[type=range] { -webkit-appearance: none; width: 100%; height: 20px; border-radius: 10px; outline: none; margin: 30px 0; border: 4px solid #000; }
        #tempo-slider { background: linear-gradient(to right, var(--easy) 0% 30%, var(--medium) 30% 60%, var(--hard) 60% 85%, var(--expert) 85% 100%); }
        #vol-slider { background: #222; height: 12px; margin: 10px 0; border: 2px solid #000; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 40px; height: 40px; border-radius: 6px; background: #fff; border: 6px solid #000; cursor: pointer; }
        #vol-slider::-webkit-slider-thumb { width: 25px; height: 25px; border-width: 4px; }

        .patch-btn { font-family: 'Press Start 2P'; font-size: 10px; padding: 12px 15px; background: #111125; color: #888; border: 3px solid #444; cursor: pointer; transition: all 0.1s; border-radius: 6px; }
        .patch-btn.active { background: var(--primary); color: #fff; border-color: #fff; box-shadow: 0 4px 0 #0b507e; transform: translateY(-4px); }

        #toggle-btn { font-family: 'Press Start 2P'; padding: 25px 70px; background: var(--arcade-red); color: #fff; border: none; box-shadow: 0 10px #9a2b3e; cursor: pointer; font-size: 1.8rem; margin-top: 20px; }
    </style>
</head>
<body>

    <div id="start-screen">
        <div class="mascot-box">
                          %*%  ##                        %*+++++++*#@
                          %+# @+# #*%                 #*++++++++++++*@   %#
                          %+# %+# #+%           @@@ @#*+++++++++++++++*@% ## #@
                   %%     #+# #+@%+*@           @@@@@%*++++++++++++++++##%*#@+@
                     #*#   #+#**+@#+#            @@@@@@@@@#++++++++++++#+#%+%%+@  @#@
                     @**@ #+*#+*%++@            @@@@@@@@@@#*@*++++++++%+##*@#+@ @*#
                      @*++++++++++#            @++#@@@@%*++%@@@@@#+++%#+*+# ** #**@
                       #++++++++++%           %*+++++++++++#@@@@@@@@@@*++++*+*#*+@
                       #++++++++++@   @@    %*+++++++++++++@@@@@@@@@@++++++++++%
                    @@@*++++++++++###***##%%+*++++++++++++++*@@@@@@ #+++++++++*@
                  @@@@@@%+++++++++++++++#****#++++++*#+++++++++@  @#++++++++++#
               @@@@@@@@@@@#++++++*######*****##+++++#****#+++**+++++++++++++++#
            @@@@@@@@@@@@@@@*#%**#*************##++++*####*+++#**####**++++++*%%@
         @@@@@@@@@@@@@@@@@ *#*******************#***++++++++********#%@#*#%@@@@@@@@
      @@@@@@@@@@@@@@@@@   *##************#######**#****++++*#*********###@@@@@@@@@@@@
    @@@@@@@@@@@@@@@@@     *#***********#%##########%**********###*####**%  @@@@@@@@@@@@
   @@@@@@@@@@@@@@@@        #*********%@@##########%#*#********####%* #      @@@@@@@@@@@@
 @@@@@@@@@@@@@@@@@@@@    ##******#@@@%@%##########@*#*************%#* @@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@*****%@@@@@%%@##########@#*###***********##* @@@@@@@@@@@@@@
@@@@@@@@@@@@@@@@@@@@@@@@@@***%@@@@@@@%@@##########%%****###%%********##@@@       @@@@
   @@@@@@@@@@@@@@@@@@@@@@@%#@@@@@@@@@@@@%#########%@*******@@@@#******%@@@@@@@@    @@
             @@@@@@@@@@@@@@@@@@@@@@@@@@@%##########@#******@@@@@@******@@@@@@@@@@@@@@
                           @@@@@@@@@@@@@@##########%%******%@@@@@@%****@@@@@@@@@@@@@@
                                @@@@@@@@@%#########%%******#@@@@@@@%***%@@@@@@@@@@@@
                                      @@@@##########@******#@@@@@@@@%*#@@@@@@@@@@@@@@
                                          @#########%@******@%@@@@@@@%@@@@@@@@@@@@@@
                                           @#########@%******@%@@@@@@@@@@@@@@@@@@@@@
                                            @#########@%******@#% @@@@@@@@@@@@@@@
                                             @@########%%#****%%#* @@@@@@
                                               @%#######%%%****%#* @%
                                                   @%%######@%***##%
                                                      @@%%%%%@@%#***
                                                                  @%
        </div>
        <div class="title-group">
            <h1 class="main-title">NANA NANA BOO BOO</h1>
            <div class="sub-title">RHYTHM ARCADE</div>
        </div>
        <button class="press-start" id="boot-btn">START GAME</button>
    </div>

    <div id="game-container">
        <div id="central-light"></div>
        <div class="picker-container" id="picker-basic"></div>
        <div id="adv-toggle">[+] SHOW ADVANCED</div>
        <div class="picker-container" id="picker-adv" style="display:none; border-top: 2px dashed #444; padding-top: 30px; margin-bottom: 20px;"></div>

        <div id="status-banner" style="font-size:2rem; margin-bottom:25px; text-shadow: 3px 3px #000;">PICK BEATS</div>
        
        <div class="measure-wrapper">
            <div id="lock-btn" title="Lock Pattern">
                <svg id="lock-icon" viewBox="0 0 24 24"><path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h1.9c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm0 12H6V10h12v10z"/></svg>
            </div>
            <div id="measure"></div>
        </div>
        
        <div class="controls">
            <div style="font-size: 16px; letter-spacing: 3px;">SPEED: <span id="tempo-val">80 BPM</span> <span id="rank-label">[EASY]</span></div>
            <input type="range" id="tempo-slider" min="40" max="200" value="80">
            
            <div style="display: flex; flex-wrap: wrap; gap: 30px; justify-content: center; margin: 30px 0; padding-top: 30px; border-top: 2px dashed #333;">
                <div style="width: 100%; max-width: 250px; text-align: center;">
                    <div style="font-size: 12px; color: var(--primary); margin-bottom: 10px;">VOLUME</div>
                    <input type="range" id="vol-slider" min="0" max="100" value="75">
                </div>
                <div style="width: 100%; max-width: 400px; text-align: center;">
                    <div style="font-size: 12px; color: var(--primary); margin-bottom: 15px;">SOUND PATCH</div>
                    <div style="display: flex; gap: 10px; justify-content: center;">
                        <button class="patch-btn active" data-patch="classic">SYNTH</button>
                        <button class="patch-btn" data-patch="bloop">BLOOP</button>
                        <button class="patch-btn" data-patch="metallic">METAL</button>
                    </div>
                </div>
            </div>
            <button id="toggle-btn">START</button>
        </div>
    </div>

<script>
    let audioCtx, masterGain, compressor;
    const light = document.getElementById('central-light'), toggleBtn = document.getElementById('toggle-btn');
    const slider = document.getElementById('tempo-slider'), volSlider = document.getElementById('vol-slider');
    const patchBtns = document.querySelectorAll('.patch-btn');
    const lockBtn = document.getElementById('lock-btn');
    const lockIcon = document.getElementById('lock-icon');
    
    let isRunning = false, tempo = 80, secondsPerBeat = 0.75, nextNoteTime = 0, currentBeatIndex = 0, isTeacherTurn = true, currentRhythm = [], soundType = 'classic';
    let isLocked = false;

    const RHYTHM_CONFIG = {
        Boo: { offsets: [0], name: "BOO" },
        Nana: { offsets: [0, 0.5], name: "NANA" },
        Gullible: { offsets: [0, 0.333, 0.666], name: "GULLIBLE" },
        LiarLiar: { offsets: [0, 0.25, 0.5, 0.75], name: "LIAR LIAR" },
        Rest: { offsets: [], name: "REST" },
        Offbeat: { offsets: [0.5], name: "" },
        Adv1: { offsets: [0, 0.5, 0.75], name: "" },
        Adv2: { offsets: [0, 0.25, 0.5], name: "" },
        Adv3: { offsets: [0, 0.25, 0.75], name: "" },
        Adv4: { offsets: [0, 0.75], name: "" },
        Adv5: { offsets: [0.25, 0.5, 0.75], name: "" },
        Adv6: { offsets: [0.5, 0.75], name: "" }
    };

    const SVGS = {
        Boo: `<svg viewBox="0 0 60 100" width="60"><ellipse cx="20" cy="80" rx="12" ry="8" fill="white" transform="rotate(-15, 20, 80)"/><rect x="29" y="20" width="4" height="62" fill="white"/></svg>`,
        Nana: `<svg viewBox="0 0 80 100" width="70"><ellipse cx="15" cy="80" rx="10" ry="7" fill="white" transform="rotate(-15, 15, 80)"/><rect x="22" y="20" width="4" height="62" fill="white"/><ellipse cx="55" cy="80" rx="10" ry="7" fill="white" transform="rotate(-15, 55, 80)"/><rect x="62" y="20" width="4" height="62" fill="white"/><rect x="22" y="20" width="44" height="10" fill="white"/></svg>`,
        Gullible: `<svg viewBox="0 0 100 100" width="85"><text x="50" y="16" fill="white" font-size="16" font-family="'Press Start 2P'" text-anchor="middle">3</text><ellipse cx="12" cy="80" rx="8" ry="6" fill="white" transform="rotate(-15, 12, 80)"/><rect x="17" y="24" width="3" height="58" fill="white"/><ellipse cx="45" cy="80" rx="8" ry="6" fill="white" transform="rotate(-15, 45, 80)"/><rect x="50" y="24" width="3" height="58" fill="white"/><ellipse cx="78" cy="80" rx="8" ry="6" fill="white" transform="rotate(-15, 78, 80)"/><rect x="83" y="24" width="3" height="58" fill="white"/><rect x="17" y="24" width="69" height="8" fill="white"/></svg>`,
        LiarLiar: `<svg viewBox="0 0 100 100" width="85"><ellipse cx="10" cy="80" rx="7" ry="5" fill="white" transform="rotate(-15, 10, 80)"/><rect x="15" y="20" width="3" height="62" fill="white"/><ellipse cx="35" cy="80" rx="7" ry="5" fill="white" transform="rotate(-15, 35, 80)"/><rect x="40" y="20" width="3" height="62" fill="white"/><ellipse cx="60" cy="80" rx="7" ry="5" fill="white" transform="rotate(-15, 60, 80)"/><rect x="65" y="20" width="3" height="62" fill="white"/><ellipse cx="85" cy="80" rx="7" ry="5" fill="white" transform="rotate(-15, 85, 80)"/><rect x="90" y="20" width="3" height="62" fill="white"/><rect x="15" y="20" width="78" height="7" fill="white"/><rect x="15" y="32" width="78" height="7" fill="white"/></svg>`,
        Rest: `<svg viewBox="0 0 60 100" width="50"><path d="M15 20 L45 20 L25 45 L45 55 L25 80" stroke="#444" stroke-width="10" fill="none" stroke-linecap="round"/></svg>`,
        Offbeat: `<svg viewBox="0 0 80 100" width="80"><path d="M20,35 Q30,28 30,40 L15,75" stroke="white" stroke-width="4" fill="none"/><circle cx="20" cy="35" r="4" fill="white"/><ellipse cx="50" cy="80" rx="10" ry="7" fill="white" transform="rotate(-15, 50, 80)"/><rect x="58" y="20" width="4" height="62" fill="white"/><path d="M58,20 Q80,35 58,50" fill="white"/></svg>`,
        Adv1: `<svg viewBox="0 0 100 100" width="85"><ellipse cx="15" cy="80" rx="7" ry="5" fill="white" transform="rotate(-15, 15, 80)"/><rect x="20" y="20" width="3" height="62" fill="white"/><ellipse cx="55" cy="80" rx="7" ry="5" fill="white" transform="rotate(-15, 55, 80)"/><rect x="60" y="20" width="3" height="62" fill="white"/><ellipse cx="85" cy="80" rx="7" ry="5" fill="white" transform="rotate(-15, 85, 80)"/><rect x="90" y="20" width="3" height="62" fill="white"/><rect x="20" y="20" width="73" height="7" fill="white"/><rect x="60" y="32" width="33" height="7" fill="white"/></svg>`,
        Adv2: `<svg viewBox="0 0 100 100" width="85"><ellipse cx="15" cy="80" rx="7" ry="5" fill="white" transform="rotate(-15, 15, 80)"/><rect x="20" y="20" width="3" height="62" fill="white"/><ellipse cx="45" cy="80" rx="7" ry="5" fill="white" transform="rotate(-15, 45, 80)"/><rect x="50" y="20" width="3" height="62" fill="white"/><ellipse cx="85" cy="80" rx="7" ry="5" fill="white" transform="rotate(-15, 85, 80)"/><rect x="90" y="20" width="3" height="62" fill="white"/><rect x="20" y="20" width="73" height="7" fill="white"/><rect x="20" y="32" width="33" height="7" fill="white"/></svg>`,
        Adv3: `<svg viewBox="0 0 100 100" width="85"><ellipse cx="15" cy="80" rx="7" ry="5" fill="white" transform="rotate(-15, 15, 80)"/><rect x="20" y="20" width="3" height="62" fill="white"/><ellipse cx="50" cy="80" rx="7" ry="5" fill="white" transform="rotate(-15, 50, 80)"/><rect x="55" y="20" width="3" height="62" fill="white"/><ellipse cx="85" cy="80" rx="7" ry="5" fill="white" transform="rotate(-15, 85, 80)"/><rect x="90" y="20" width="3" height="62" fill="white"/><rect x="20" y="20" width="73" height="7" fill="white"/><rect x="20" y="32" width="12" height="7" fill="white"/><rect x="78" y="32" width="15" height="7" fill="white"/></svg>`,
        Adv4: `<svg viewBox="0 0 100 100" width="85"><ellipse cx="25" cy="80" rx="9" ry="6" fill="white" transform="rotate(-15, 25, 80)"/><rect x="32" y="20" width="4" height="62" fill="white"/><circle cx="48" cy="75" r="4" fill="white"/><ellipse cx="75" cy="80" rx="7" ry="5" fill="white" transform="rotate(-15, 75, 80)"/><rect x="80" y="20" width="3" height="62" fill="white"/><rect x="32" y="20" width="51" height="8" fill="white"/><rect x="68" y="32" width="15" height="7" fill="white"/></svg>`,
        Adv5: `<svg viewBox="0 0 100 100" width="85"><path d="M 15,30 Q 23,25 23,35 L 15,55" stroke="white" stroke-width="2.5" fill="none"/><circle cx="15" cy="30" r="3" fill="white"/><path d="M 10,45 Q 18,40 18,50 L 5,75" stroke="white" stroke-width="2.5" fill="none"/><circle cx="10" cy="45" r="3" fill="white"/><ellipse cx="35" cy="80" rx="7" ry="5" fill="white" transform="rotate(-15, 35, 80)"/><rect x="40" y="20" width="3" height="62" fill="white"/><ellipse cx="60" cy="80" rx="7" ry="5" fill="white" transform="rotate(-15, 60, 80)"/><rect x="65" y="20" width="3" height="62" fill="white"/><ellipse cx="85" cy="80" rx="7" ry="5" fill="white" transform="rotate(-15, 85, 80)"/><rect x="90" y="20" width="3" height="62" fill="white"/><rect x="40" y="20" width="53" height="7" fill="white"/><rect x="40" y="32" width="53" height="7" fill="white"/></svg>`,
        Adv6: `<svg viewBox="0 0 100 100" width="85"><path d="M 20,35 Q 30,28 30,40 L 15,75" stroke="white" stroke-width="3" fill="none"/><circle cx="20" cy="35" r="3.5" fill="white"/><ellipse cx="55" cy="80" rx="7" ry="5" fill="white" transform="rotate(-15, 55, 80)"/><rect x="60" y="20" width="3" height="62" fill="white"/><ellipse cx="85" cy="80" rx="7" ry="5" fill="white" transform="rotate(-15, 85, 80)"/><rect x="90" y="20" width="3" height="62" fill="white"/><rect x="60" y="20" width="33" height="7" fill="white"/><rect x="60" y="32" width="33" height="7" fill="white"/></svg>`
    };

    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            compressor = audioCtx.createDynamicsCompressor();
            compressor.threshold.setValueAtTime(-20, audioCtx.currentTime);
            compressor.knee.setValueAtTime(40, audioCtx.currentTime);
            compressor.ratio.setValueAtTime(12, audioCtx.currentTime);
            compressor.attack.setValueAtTime(0, audioCtx.currentTime);
            compressor.release.setValueAtTime(0.25, audioCtx.currentTime);
            masterGain = audioCtx.createGain();
            masterGain.connect(compressor);
            compressor.connect(audioCtx.destination);
            masterGain.gain.value = (volSlider.value / 100) * 1.5;
        }
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    volSlider.oninput = (e) => {
        if (masterGain) masterGain.gain.value = (e.target.value / 100) * 1.5;
    };

    patchBtns.forEach(btn => {
        btn.onclick = () => {
            patchBtns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            soundType = btn.dataset.patch;
            initAudio(); 
            playTone(600, audioCtx.currentTime, 0.2, 0.1, false); 
        };
    });

    lockBtn.onclick = () => {
        isLocked = !isLocked;
        lockBtn.classList.toggle('locked', isLocked);
        lockIcon.innerHTML = isLocked ? 
            `<path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/>` : 
            `<path d="M12 17c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6h1.9c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm0 12H6V10h12v10z"/>`;
        initAudio();
    };

    Object.keys(RHYTHM_CONFIG).forEach(key => {
        const card = document.createElement('div');
        const isDefault = (key === 'Boo' || key === 'Nana');
        card.className = `rhythm-card ${isDefault ? 'selected' : ''}`;
        card.dataset.type = key;
        const label = RHYTHM_CONFIG[key].name ? `<div style="font-size:9px;">${RHYTHM_CONFIG[key].name}</div>` : '';
        card.innerHTML = SVGS[key] + label;
        card.onclick = () => { card.classList.toggle('selected'); initAudio(); };
        if (RHYTHM_CONFIG[key].name && key !== 'Offbeat') {
            document.getElementById('picker-basic').appendChild(card);
        } else {
            document.getElementById('picker-adv').appendChild(card);
        }
    });

    document.getElementById('adv-toggle').onclick = function() {
        const panel = document.getElementById('picker-adv');
        panel.style.display = panel.style.display === 'none' ? 'flex' : 'none';
        this.innerText = panel.style.display === 'none' ? '[+] SHOW ADVANCED' : '[-] HIDE ADVANCED';
    };

    function playTone(freq, time, vol = 0.2, dur = 0.1, isMetronome = false) {
        if(!audioCtx) return;
        const g = audioCtx.createGain();
        g.connect(masterGain);
        g.gain.setValueAtTime(vol, time);
        g.gain.exponentialRampToValueAtTime(0.0001, time + dur);
        if (isMetronome) {
            const osc = audioCtx.createOscillator();
            osc.frequency.setValueAtTime(freq, time);
            osc.connect(g);
            osc.start(time); osc.stop(time + dur);
            return;
        }
        if (soundType === 'classic') {
            const osc = audioCtx.createOscillator();
            osc.type = 'square';
            osc.frequency.setValueAtTime(freq * 1.5, time);
            osc.connect(g);
            osc.start(time); osc.stop(time + dur);
        } else if (soundType === 'bloop') {
            const osc = audioCtx.createOscillator();
            osc.type = 'sine';
            osc.frequency.setValueAtTime(freq * 2.5, time);
            osc.frequency.exponentialRampToValueAtTime(freq * 0.2, time + dur);
            osc.connect(g);
            osc.start(time); osc.stop(time + dur);
        } else if (soundType === 'metallic') {
            [1.5, 3.42].forEach(m => {
                const osc = audioCtx.createOscillator();
                osc.type = m === 1.5 ? 'square' : 'sawtooth';
                osc.frequency.setValueAtTime(freq * m, time);
                osc.connect(g);
                osc.start(time); osc.stop(time + dur);
            });
        }
    }

    function schedule() {
        while (isRunning && nextNoteTime < audioCtx.currentTime + 0.1) {
            playTone(currentBeatIndex === 0 ? 300 : 150, nextNoteTime, 0.05, 0.05, true);
            const type = currentRhythm[currentBeatIndex];
            const offsets = RHYTHM_CONFIG[type].offsets;
            
            // Logic updated: trigger light for BOTH phases, but only play sound for Teacher
            offsets.forEach(offset => {
                const hitTime = nextNoteTime + (offset * secondsPerBeat);
                if (isTeacherTurn) {
                    playTone(600, hitTime, 0.2, 0.1, false);
                }
                triggerLight(hitTime, isTeacherTurn);
            });

            updateUI(currentBeatIndex, nextNoteTime, isTeacherTurn);
            nextNoteTime += secondsPerBeat;
            currentBeatIndex++;
            if (currentBeatIndex > 3) {
                currentBeatIndex = 0; isTeacherTurn = !isTeacherTurn;
                if (isTeacherTurn && !isLocked) { 
                    const selected = Array.from(document.querySelectorAll('.rhythm-card.selected')).map(c => c.dataset.type);
                    currentRhythm = Array.from({length:4}, () => selected[Math.floor(Math.random()*selected.length)]);
                }
            }
        }
        if (isRunning) requestAnimationFrame(schedule);
    }

    function triggerLight(time, teacher) {
        const delay = (time - audioCtx.currentTime) * 1000;
        setTimeout(() => {
            if (!isRunning) return;
            light.classList.remove('light-flash');
            void light.offsetWidth;
            light.classList.add('light-flash');
            // Color logic: Orange for Teacher, Green for Student
            light.style.backgroundColor = teacher ? 'var(--teacher)' : 'var(--student)';
        }, delay);
    }

    function updateUI(idx, time, teacher) {
        const delay = (time - audioCtx.currentTime) * 1000;
        setTimeout(() => {
            if (!isRunning) return;
            if (idx === 0 && teacher) {
                const m = document.getElementById('measure'); m.innerHTML = '';
                currentRhythm.forEach(key => {
                    const c = document.createElement('div'); c.className = 'beat-cell';
                    const label = RHYTHM_CONFIG[key].name ? `<div style="font-size:12px; margin-top:10px;">${RHYTHM_CONFIG[key].name}</div>` : '';
                    c.innerHTML = SVGS[key] + label;
                    m.appendChild(c);
                });
            }
            document.getElementById('status-banner').innerText = teacher ? "WATCH!" : "CLAP!";
            document.getElementById('status-banner').style.color = teacher ? "var(--teacher)" : "var(--student)";
            document.getElementById('measure').className = teacher ? "teacher-active" : "student-active";
            const cells = document.querySelectorAll('.beat-cell');
            cells.forEach(c => c.classList.remove('active'));
            if (cells[idx]) cells[idx].classList.add('active');
        }, delay);
    }

    slider.oninput = (e) => {
        tempo = e.target.value; secondsPerBeat = 60/tempo;
        document.getElementById('tempo-val').innerText = tempo + " BPM";
        let rk = tempo < 90 ? {t:"[EASY]", c:"--easy"} : tempo < 140 ? {t:"[MED]", c:"--medium"} : tempo < 180 ? {t:"[HARD]", c:"--hard"} : {t:"[EXPERT]", c:"--expert"};
        document.getElementById('rank-label').innerText = rk.t;
        document.getElementById('rank-label').style.color = `var(${rk.c})`;
    };

    const bootAction = () => { initAudio(); document.getElementById('start-screen').classList.add('hidden'); document.getElementById('game-container').classList.add('visible'); };
    document.getElementById('boot-btn').onclick = bootAction;

    toggleBtn.onclick = () => {
        initAudio();
        if (!isRunning) {
            const selected = Array.from(document.querySelectorAll('.rhythm-card.selected')).map(c => c.dataset.type);
            if (selected.length === 0) return;
            if (selected.includes("Nana") && selected.includes("Boo")) {
                currentRhythm = ["Nana", "Nana", "Boo", "Boo"];
            } else {
                currentRhythm = Array.from({length:4}, () => selected[Math.floor(Math.random() * selected.length)]);
            }
            isRunning = true; currentBeatIndex = 0; isTeacherTurn = true;
            nextNoteTime = audioCtx.currentTime + 0.1;
            toggleBtn.innerText = "STOP"; schedule();
        } else {
            isRunning = false; toggleBtn.innerText = "START";
        }
    };
    slider.dispatchEvent(new Event('input'));
</script>
</body>
</html>
